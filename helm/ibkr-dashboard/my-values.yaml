# Default values for ibkr-dashboard.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

global:
    labels:
      env: dev
      app: ibkr-dash
      
configmaps:
  dashboard: 
    name: ibkr-nginx-config-helm
    data:
      default.conf: "server {\nlisten       8443 ssl;\nlisten  [::]:8443 ssl;\nserver_name  localhost;\nssl_certificate /usr/src/app/certchain/tls.crt;\nssl_certificate_key /usr/src/app/certchain/tls.key;\n#magic___^_^___line\n#access_log  /var/log/nginx/host.access.log  main;\n#magic___^_^___line\nlocation / {\n    root   /usr/src/app/webserver/static;\n    index  index.html;\n    #magic___^_^___line\n    auth_basic \"Restricted\";\n    auth_basic_user_file  /etc/nginx/htpasswd/.htpasswd;\n    #magic___^_^___line\n    include  /etc/nginx/mime.types;\n}\n    #magic___^_^___line\n#error_page  404              /404.html;\n    #magic___^_^___line\n# redirect server error pages to the static page /50x.html\n#\nerror_page   500 502 503 504  /50x.html;\nlocation = /50x.html {\n    root   /usr/src/app/webserver/static;\n}\n    #magic___^_^___line\n# proxy the PHP scripts to Apache listening on 127.0.0.1:80\n#\n#location ~ \\.php$ {\n#    proxy_pass   http://127.0.0.1;\n#}\n    #magic___^_^___line\n# pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000\n#\n#location ~ \\.php$ {\n#    root           html;\n#    fastcgi_pass   127.0.0.1:9000;\n#    fastcgi_index  index.php;\n#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;\n#    include        fastcgi_params;\n#}\n    #magic___^_^___line\n# deny access to .htaccess files, if Apache's document root\n# concurs with nginx's one\n#\n#location ~ /\\.ht {\n#    deny  all;\n#}\n}   \n"

secrets:
  dashboard:
      users:
        name: ibkr-dashboard-secrets-users-helm
      name: ibkr-dashboard-secrets-helm
  ibeam:
    name: ibkr-ibeam-creds-helm

persistentvolumes:
  name: ibkrweb-pv-volume-helm
  path: /mnt/ibkr/web-data

persistentVolumeClaim:
  claimName: ibkrweb-pv-claim-helm

services:
  - name: ibkr-dashboard-helm
    selector:
      name: ibkr-dashboard-helm
      app: ibkr-dash
    ports:
    - protocol: TCP
      port: 8443
      targetPort: 8443
    type: NodePort
  - name: ibkr-dashboard-helm-ingress
    selector:
      name: ibkr-dashboard-helm
      app: ibkr-dash
    ports:
    - protocol: TCP
      port: 8443
      targetPort: 8443
    type: ClusterIP
  - name: ibkr-ibeam-helm
    selector:
      name: ibkr-ibeam-helm
      app: ibkr-dash
    ports:
    - protocol: TCP
      port: 5000
      targetPort: 5000
    type: NodePort
  - name: ibeam
    selector:
      name: ibkr-ibeam-helm
      app: ibkr-dash
    ports:
    - name: ibeam-gateway-helm
      protocol: TCP
      port: 5000
      targetPort: 5000
    type: ClusterIP

deployments:
  - name: ibkr-dashboard-helm
    image: adamlechnos/ibkr-dashboard-nginx
    labels:
      app: ibkr-dash
      name: ibkr-dashboard-helm
    ports:
      - containerPort: 8443
    volumeMounts:
      - mountPath: "/usr/src/app/webserver"
        name: "ibkrweb-pv-volume-helm"
      - mountPath: "/usr/src/app/certchain"
        name: ibkr-dashboard-secrets-helm
        readOnly: true
      - mountPath: "/etc/nginx/conf.d"
        name: ibkr-nginx-config-helm
        readOnly: true
      - mountPath: "/etc/nginx/htpasswd"
        name: ibkr-dashboard-secrets-users-helm
        readOnly: true
    volumes:
      - name: ibkrweb-pv-volume-helm
        persistentVolumeClaim:
          claimName: ibkrweb-pv-claim-helm
      - name: ibkr-dashboard-secrets-helm
        secret:
          secretName: ibkr-dashboard-secrets-helm
      - name: ibkr-dashboard-secrets-users-helm
        secret:
          secretName: ibkr-dashboard-secrets-users-helm
      - name: ibkr-nginx-config-helm
        configMap:
          name: ibkr-nginx-config-helm
    resources:
      limits:
        memory: "50Mi"
        cpu: "100m"
    lifecycle:
      postStart:
        exec:
          command:
          - "/bin/sh"
          - "-c"
          - if [[ ! -d  /usr/src/app/webserver/images ]]; then mkdir -p /usr/src/app/webserver/images; fi
          - cp /usr/src/app/webserver/*.svg /usr/src/app/webserver/images"
  - name: ibkr-ibeam-helm
    image: adamlechnos/ibeam
    labels:
      app: ibkr-dash
      name: ibkr-ibeam-helm
    envFrom:
    - secretRef:
        name: ibkr-ibeam-creds-helm
    ports:
      - containerPort: 5000
      - containerPort: 5001
    resources:
      limits:
        memory: "750Mi"
        cpu: "200m"
  - name: ibkr-api-parser-helm
    image: adamlechnos/ibkr-create-website
    labels:
      app: ibkr-dash
      name: ibkr-api-parser-helm
    env:
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: sleepTimeSeconds
      value: "60"
    - name: webPageTitle
      value: "IBKR Dashboard"
    volumeMounts:
      - mountPath: "/usr/src/app/webserver"
        name: "ibkrweb-pv-volume-helm"
    volumes:
      - name: ibkrweb-pv-volume-helm
        persistentVolumeClaim:
          claimName: ibkrweb-pv-claim-helm
    resources:
      limits:
        memory: "50Mi"
        cpu: "100m"